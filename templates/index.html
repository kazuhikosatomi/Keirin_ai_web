<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>å‡ºèµ°è¡¨ï¼ˆçµã‚Šè¾¼ã¿è¡¨ç¤ºï¼‰</title>
    <style>
        body { font-family: sans-serif; }
        table { border-collapse: collapse; width: 100%; font-size: 13px; }
        th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
        th { background: #f0f0f0; }
    </style>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#000000">
</head>
<body>
    <h2>å‡ºèµ°è¡¨URLã‹ã‚‰é¸æ‰‹æƒ…å ±ã‚’è¡¨ç¤º</h2>
    <form method="POST" onsubmit="showLoading()">
      <div id="loading" style="display:none; color:red; font-weight:bold;">â³ å‡ºèµ°è¡¨ã‚’å–å¾—ä¸­ã§ã™...</div>
      <label>æ—¥ä»˜:</label>
      <input type="date" name="date" value="{{ today }}" required>

      <label>é–‹å‚¬å ´:</label>
      <select name="venue_id" required>
        {% for venue in venues %}
          <option value="{{ venue.venue_id }}" {% if venue.venue_id == selected_venue %}selected{% endif %}>
            {{ venue.venue_name }}
          </option>
        {% endfor %}
      </select>

      <label>ãƒ¬ãƒ¼ã‚¹ç•ªå·:</label>
      <select name="race" required>
        {% for i in range(1, 13) %}
          <option value="{{ i }}" {% if i|string == selected_race %}selected{% endif %}>
            {{ i }}R
          </option>
        {% endfor %}
      </select>

      <script>
        function showLoading() {
          document.getElementById('loading').style.display = 'block';
        }
      </script>
      <button type="submit">å‡ºèµ°è¡¨ã‚’å–å¾—</button>
    </form>

    {% if result and result.error %}
      <div style="margin-top: 1em; padding: 0.5em; border: 2px solid red; color: red; font-weight: bold; background-color: #ffeaea; white-space: pre-wrap;">
        âš ï¸ {{ result.error }}
      </div>
    {% endif %}

    {% if result.meta %}
        <p style="font-weight: bold; font-size: 15px;">
          è’ã‚Œåº¦ã‚¹ã‚³ã‚¢ï¼ˆäºˆæ¸¬ï¼‰:
          <span id="araredo-score">å–å¾—ä¸­...</span>
        </p>
        <script>
          const url = `/araredo_predict?date={{ result.meta.date }}&venue_id={{ result.meta.place_code }}&race={{ result.meta.race_num }}`;
          console.log("ğŸ” è’ã‚Œåº¦å–å¾—URL:", url);

          fetch(url)
            .then(response => response.json())
            .then(data => {
              console.log("âœ… å–å¾—çµæœ:", data);
              document.getElementById('araredo-score').textContent = data.araredo_score ?? "å–å¾—å¤±æ•—";
            })
            .catch(error => {
              console.error("âŒ fetchã‚¨ãƒ©ãƒ¼:", error);
              document.getElementById('araredo-score').textContent = "å–å¾—å¤±æ•—";
            });
        </script>
    {% endif %}

    {% if result %}
    {% if not result.error %}
        <table>
            <tr>
                <th>æ ç•ª</th><th>è»Šç•ª</th><th>åå‰</th><th>å¹´é½¢</th><th>åºœçœŒ</th><th>æœŸåˆ¥</th><th>ç´šç­</th>
                <th>è„šè³ª</th><th>ã‚®ã‚¢</th><th>å¾—ç‚¹</th><th>1ç€</th><th>2ç€</th><th>3ç€</th><th>ç€å¤–</th>
                <th>å‹ç‡</th><th>2é€£å¯¾</th><th>3é€£å¯¾</th>
                <th>é€ƒ</th><th>æ²</th><th>å·®</th><th>ãƒ</th>
                <th>S</th><th>B</th><th>Line</th><th>Pos</th>
            </tr>
            {% for r in result.entries %}
            <tr>
                <td>{{ r.frame_number }}</td>
                <td>{{ r.car_number }}</td>
                <td>{{ r.name }}</td>
                <td>{{ r.age }}</td>
                <td>{{ r.prefecture }}</td>
                <td>{{ r.term }}</td>
                <td>{{ r.grade }}</td>
                <td>{{ r.leg_type }}</td>
                <td>{{ r.gear }}</td>
                <td>{{ r.score }}</td>
                <td>{{ r.first_places }}</td>
                <td>{{ r.second_places }}</td>
                <td>{{ r.third_places }}</td>
                <td>{{ r.outs }}</td>
                <td>{{ r.win_rate }}</td>
                <td>{{ r.top2_rate }}</td>
                <td>{{ r.top3_rate }}</td>
                <td>{{ r.style_escape }}</td>
                <td>{{ r.style_sprint }}</td>
                <td>{{ r.style_chase }}</td>
                <td>{{ r.style_other }}</td>
                <td>{{ r.start_number }}</td>
                <td>{{ r.back_number }}</td>
                <td>{{ r.line_id }}</td>
                <td>{{ r.line_pos }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endif %}
    {% endif %}
</body>
<script>
  let calendarData = [];

  fetch("/calendar_data")
    .then(response => response.json())
    .then(data => {
      calendarData = data;
    });

  document.querySelector('input[name="date"]').addEventListener('change', function () {
    const selectedDate = this.value.replace(/\D/g, "");
    const venueSelect = document.querySelector('select[name="venue_id"]');
    venueSelect.innerHTML = ""; // clear options

    console.log("ğŸ“… calendarData sample:", calendarData[0]);
    const venues = calendarData.filter(entry => entry.date.replace(/\D/g, "") === selectedDate);
    console.log("é¸æŠæ—¥:", selectedDate);
    console.log("è©²å½“é–‹å‚¬å ´:", venues);

    if (venues.length === 0) {
      const option = document.createElement("option");
      option.value = "";
      option.textContent = "è©²å½“ãªã—";
      venueSelect.appendChild(option);
      return;
    }

    venues.forEach(entry => {
      const option = document.createElement("option");
      option.value = entry.venue_id || entry.venue_code;
      option.textContent = entry.venue_name;
      venueSelect.appendChild(option);
    });
  });
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/service-worker.js')
        .then(function(reg) {
          console.log("âœ… Service Worker registered");
        }).catch(function(err) {
          console.log("âŒ Service Worker registration failed:", err);
        });
    });
  }
</script>
</html>